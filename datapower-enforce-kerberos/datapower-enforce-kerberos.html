<style>.hljs{display:block;overflow-x:auto;padding:.5em;background:#fff;color:#000}.hljs-comment,.hljs-quote{color:#006a00}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#aa0d91}.hljs-name{color:#008}.hljs-template-variable,.hljs-variable{color:#660}.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#080}.hljs-bullet,.hljs-meta,.hljs-number,.hljs-symbol,.hljs-tag,.hljs-title{color:#1c00cf}.hljs-attr,.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-section,.hljs-type{color:#5c2699}.hljs-attribute,.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}.pn-copy ol>li>p{margin-top:0}.pn-copy h3{font-size:2rem}.pn-copy ol.table-of-contents>li{margin-top:0;margin-bottom:0}.pn-copy ol.table-of-contents ol.subheading{margin-top:0;margin-bottom:0}.pn-copy ol.table-of-contents ol.subheading>li{margin-bottom:0}.pn-copy h2{padding-top:1em}.pn-copy h1,.pn-copy h2,.pn-copy h3{clear:both}.pn-copy .border{border:1px solid #2d2e31}.pn-copy .figure{max-width:66%}.pn-copy ol.table-of-contents ol.subheading{list-style:upper-alpha}</style><a name="using-ibm-datapower-gateway-v7-5-to-enforce-kerberos-security"><span class="header-link"></span></a><h2>Table of Contents</h2><ol class="table-of-contents"><li><a href="#using-ibm-datapower-gateway-v7-5-to-enforce-kerberos-security">Using IBM DataPower Gateway v7.5 to enforce Kerberos Security</a><ol class="subheading"><li><a href="#domain-name-server-configuration">Domain Name Server configuration</a></li><li><a href="#active-directory-configuration">Active Directory Configuration</a></li><li><a href="#defining-the-service-principal-name-spn-for-datapower-service">Defining the Service Principal Name (SPN) for DataPower service</a></li><li><a href="#generating-the-kerberos-keytab-file-to-be-imported-in-datapower-gateway">Generating the Kerberos Keytab file to be imported in DataPower Gateway</a></li><li><a href="#creating-a-multiprotocol-gateway-on-datapower">Creating a Multiprotocol Gateway on DataPower</a></li><li><a href="#using-an-http-client-to-test-the-configuration">Using an HTTP client to test the configuration</a></li><li><a href="#troubleshooting-tips">Troubleshooting Tips</a></li></ol></li></ol><h2 class="first-section">Using IBM DataPower Gateway v7.5 to enforce Kerberos Security</h2><p><a href="https://github.com/ibm-datapower/datapower-tutorials/tree/master/datapower-enforce-kerberos">https://github.com/ibm-datapower/datapower-tutorials/tree/master/datapower-enforce-kerberos</a></p> <p>The IBM DataPower Gateway is widely used in the industry to protect backend resources from unauthorized accesses, enforcing enterprise security policies and, at the same time, offloading the backend servers from all security-related activities. The article shows how to configure IBM DataPower Gateway in order to protect a HTTP resource enforcing Kerberos security. In the proposed scenario, the DataPower appliance will allow a HTTP client to invoke a HTTP service only if the HTTP request will carry a valid SPNEGO token. To test the correct behaviour of the system a SmartBear SoapUI will be used on a Client machine.</p> <p><a href="/wp-content/uploads/sites/88/2018/05/ArchitectureOutline.png"><img src="/wp-content/uploads/sites/88/2018/05/ArchitectureOutline.png" alt="Architecture outline" class="alignnone size-full" height="560" width="1652"></a></p> <a name="domain-name-server-configuration"><span class="header-link"></span></a><h3>Domain Name Server configuration</h3><p>As a preliminary step, we have to configure at least two entries in the Domain DNS, one for the Windows Server machine, the other for the DataPower Gateway. Using the server manager, access the DNS manager:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/ServerManagerDashboard-DNS.png"><img src="/wp-content/uploads/sites/88/2018/05/ServerManagerDashboard-DNS.png" alt="Server Manager Dashboard - DNS" class="alignnone size-full" height="627" width="1003"></a></p> <p>Select <strong>Action</strong>-&gt;<strong>New Host (A or AAAA)</strong> and create an entry for DataPower Gateway:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/DNSManager-NewHost.png"><img src="/wp-content/uploads/sites/88/2018/05/DNSManager-NewHost.png" alt="DNS Manager - New Host" class="alignnone size-full" height="705" width="1003"></a></p> <p>The same for the Windows Server machine (<code>winserver</code>), so that the DNS list will appear as follows:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/DNSManager-HostAdded.png"><img src="/wp-content/uploads/sites/88/2018/05/DNSManager-HostAdded.png" alt="DNS Manager - Host Added" class="alignnone size-full" height="704" width="1003"></a></p> <a name="active-directory-configuration"><span class="header-link"></span></a><h3>Active Directory Configuration</h3><p>In this section are described the configuration steps to be executed on Microsoft Active Directory in order to define a new <em>pseudo</em> User ID. In the next section, the newly created user ID will be associated with a new Service Principal Name that will uniquely identify our DataPower service.</p> <ol> <li><p>In the Server Manager, select <strong>Tools</strong>-&gt;<strong>Active Directory Users and Computers</strong>:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/ADConfStep1.png"><img src="/wp-content/uploads/sites/88/2018/05/ADConfStep1.png" alt="ActiveDirectory Configuration - Step1" class="alignnone size-full" height="595" width="1003"></a></p> </li> <li><p>Create a new user, let say <code>dp</code>:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/ADConfStep2.png"><img src="/wp-content/uploads/sites/88/2018/05/ADConfStep2.png" alt="ActiveDirectory Configuration - Step2" class="alignnone size-full" height="585" width="1003"></a></p> </li> <li><p>Fill required fields as shown below and click <strong>Next</strong>:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/ADConfStep3.png"><img src="/wp-content/uploads/sites/88/2018/05/ADConfStep3.png" alt="ActiveDirectory Configuration - Step3" class="alignnone size-full" height="640" width="740"></a></p> </li> <li><p>Set a password (let say <code>Passw0rd!</code>), and modify the check boxes status so that the user might NOT change the password at the next logon and the password never expires, as shown below. Click <strong>Next</strong> and then <strong>Finish</strong> to complete the wizard.</p> <p><a href="/wp-content/uploads/sites/88/2018/05/ADConfStep4.png"><img src="/wp-content/uploads/sites/88/2018/05/ADConfStep4.png" alt="ActiveDirectory Configuration - Step4" class="alignnone size-full" height="640" width="742"></a></p> </li> </ol> <p>Right-click the newly created user from the list of all available users and select <strong>Properties</strong>, then enter the <strong>Account</strong> tab:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/ADAccountTab.png"><img src="/wp-content/uploads/sites/88/2018/05/ADAccountTab.png" alt="ActiveDirectory Configuration - Account Tab" class="alignnone size-full" height="913" width="696"></a></p> <p>In the <strong>Account options</strong> only four options are to be checked: the first is <strong>Password never expires</strong> (as set before); the others are at the bottom of the list, as shown below:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/ADAccountOptions.png"><img src="/wp-content/uploads/sites/88/2018/05/ADAccountOptions.png" alt="ActiveDirectory Configuration - Account Options" class="alignnone size-full" height="227" width="771"></a></p> <p>These settings give maximum flexibility about the encryption algorithm the account can use. This means that Kerberos ticket that will be exchanged between the client and the DataPower service (i.e. the <code>dp</code> user we have just created) can be encrypted using a wide range of algorithms, giving maximum interoperability.</p> <a name="defining-the-service-principal-name-spn-for-datapower-service"><span class="header-link"></span></a><h3>Defining the Service Principal Name (SPN) for DataPower service</h3><p>This section shows how to create a new Service Principal Name (SPN) for DataPower services and how to associate them with the <code>dp</code> user created in the previous section. The SPN creation is made via command line (DOS prompt), using the <code>setspn</code> command.</p> <p>First, verify that the user <code>dp</code> does not have associated any SPN. Run the command:</p> <pre><code>setspn -l dp
</code></pre><p>The output must be empty: no SPN registered for <code>dp</code> user:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/CMDNoSPN.png"><img src="/wp-content/uploads/sites/88/2018/05/CMDNoSPN.png" alt="Command Prompt - No SPN Registered" class="alignnone size-full" height="305" width="1003"></a></p> <p>Now, create the new SPN and associate it to <code>dp</code> user:</p> <pre><code>setspn -a HTTP/datapower.mydomain.local dp
</code></pre><p>Run again the following:</p> <pre><code>setspn -l dp
</code></pre><p>and verify that the SPN has been associated correctly:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/CMDOkSPN.png"><img src="/wp-content/uploads/sites/88/2018/05/CMDOkSPN.png" alt="Command Prompt - SPN Registered" class="alignnone size-full" height="305" width="1003"></a></p> <p>Using again the Active Directory user interface, entering in the properties of <code>dp</code> user, account tab, you should see the <strong>User logon name</strong> changed accordingly to the <code>HTTP/datapower.mydomain.local</code>:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/ADUserLogonName.png"><img src="/wp-content/uploads/sites/88/2018/05/ADUserLogonName.png" alt="Active Directory Configuration - UserLogonName" class="alignnone size-full" height="913" width="698"></a></p> <a name="generating-the-kerberos-keytab-file-to-be-imported-in-datapower-gateway"><span class="header-link"></span></a><h3>Generating the Kerberos Keytab file to be imported in DataPower Gateway</h3><p>This section show how to generate the <em>keytab</em> file, i.e. the artifact to import in the DataPower AAA action, in order to decrypt, parse and validate the Kerberos ticket sent by the client. The keytab file is generated via command line (DOS prompt), using the <code>ktpass</code> command. Using the <code>-?</code> flag, the command will show an online help:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/CMDOktpassHelp.png"><img src="/wp-content/uploads/sites/88/2018/05/CMDOktpassHelp.png" alt="Command Prompt - ktpass help" class="alignnone size-full" height="948" width="1003"></a></p> <p>In our scenario, we’ll pass following parameters:</p> <ul> <li><em>out</em>: the name of the keytab file fo produce</li> <li><em>princ</em>: the principal name that we have create before, in the form <code>SPN@REALM</code> - in our case, the SPN is <code>HTTP/datapower.mydomain.local</code> and the realm is <code>MYDOMAIN.LOCAL</code></li> <li><em>mapUser</em>: the active directory username we associated to the SPN, i.e. <code>dp</code></li> <li><em>mapOp</em>: the action to perform to set the mapping attribute, in our case is <code>set</code> (the alternative is <code>add</code>)</li> <li><em>+rndPass</em>: to force the command to generate a random password</li> <li><em>crypto</em>: the crypto system to use generating the keymap; in our case we’ll specify <code>All</code> to give maximum interoperability to the client</li> <li><em>ptype</em>: the type of the principal we are going to create, in our case we’ll specify <code>KRB5_NT_PRINCIPAL</code> to intend a a general principal</li> </ul> <pre><code>ktpass -out pocAllCrypto.keytab -princ HTTP/datapower.mydomain.local@MYDOMAIN.LOCAL -mapUser dp -mapOp set +rndpass -crypto All -ptype KRB5_NT_PRINCIPAL
</code></pre><p><a href="/wp-content/uploads/sites/88/2018/05/CMDktpassRun.png"><img src="/wp-content/uploads/sites/88/2018/05/CMDktpassRun.png" alt="Command Prompt - ktpass run" class="alignnone size-full" height="499" width="1003"></a></p> <p>Assure that the command discovers automatically the target domain controller, in out case is <code>winserver.mydomain.local</code>, and that the SPN is successfully mapped to our <code>dp</code> user. As you see, all keys will be created, one per crypto algorithm supported. The file <code>pocAllCrypto.keytab</code> is now created and ready to be imported in the DataPower AAA action.</p> <a name="creating-a-multiprotocol-gateway-on-datapower"><span class="header-link"></span></a><h3>Creating a Multiprotocol Gateway on DataPower</h3><p>In this section, we’ll create a new Multiprotocol Gateway on DataPower in order to protect a public Internet resource. For simplicity, let that resource the public IBM home page at <code>http://www.ibm.com</code>.</p> <p>IMPORTANT: As preliminary step, verify that the DataPower clock is in synch with the Domain Controller clock (i.e. the Windows Server machine). The clock difference must be less than few seconds or, better, the two clocks should be in synch with a common NTP server.</p> <p>Create a new Multiprotocol Gateway called <code>KerberosMPG</code> as described below:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/KerberosMPGCreation.png"><img src="/wp-content/uploads/sites/88/2018/05/KerberosMPGCreation.png" alt="IDG Console - KerberosMPG Creation" class="alignnone size-full" height="876" width="1003"></a></p> <p>Set as <code>Default Backend URL</code> an available resource, e.g. <a href="http://www.ibm.com">http://www.ibm.com</a> Set as <code>Request Type</code> and <code>Response Type</code> the <code>Non-XML</code> option, because the resource set before in an HTML page. Add an <code>HTTP Handler</code> preferably listening on port 80, enabling the <code>GET</code> method, and leaving all other fields at the default value:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/FSHCreation.png"><img src="/wp-content/uploads/sites/88/2018/05/FSHCreation.png" alt="IDG Console - FSH Creation" class="alignnone size-full" height="1249" width="1003"></a></p> <p>Create a new processing policy called <code>KerberosPolicy</code>, having two processing rule, the first with the direction Client to Server, the second from Server to Client. Configure the first rule, as follows:</p> <ul> <li>a Match action matching all incoming requests (e.g. setting a rule matching all URLs)</li> <li>a AAA action</li> <li>a Return action</li> </ul> <p>and the second rule having:</p> <ul> <li>a Match action matching all incoming requests (e.g. setting a rule matching all URLs)</li> <li>a Return action</li> </ul> <p><a href="/wp-content/uploads/sites/88/2018/05/MPGRequestRule.png"><img src="/wp-content/uploads/sites/88/2018/05/MPGRequestRule.png" alt="IDG Console - MPG Request Rule" class="alignnone size-full" height="535" width="1003"></a></p> <p><a href="/wp-content/uploads/sites/88/2018/05/MPGResponseRule.png"><img src="/wp-content/uploads/sites/88/2018/05/MPGResponseRule.png" alt="IDG Console - MPG Response Rule" class="alignnone size-full" height="534" width="1003"></a></p> <p>The authentication policy is governed by the AAA action, let it <code>KerberosAAA</code>. The action is configured as follows.</p> <ol> <li><p><strong>Identification Method</strong>: must be set to <code>Kerberos AP-REQ from SPNEGO token</code>:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/AAAIdentification.png"><img src="/wp-content/uploads/sites/88/2018/05/AAAIdentification.png" alt="IDG Console - AAA Identification" class="alignnone size-full" height="784" width="1003"></a></p> </li> <li><p><strong>Authentication Method</strong>: must be set to <code>Validate Kerberos AP-REQ for server principal</code>:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/AAAAuthentication.png"><img src="/wp-content/uploads/sites/88/2018/05/AAAAuthentication.png" alt="IDG Console - AAA Authentication" class="alignnone size-full" height="719" width="1003"></a></p> <p>When you check this option, the user interface gives you the possibility to create a keytab object: click on <code>+</code> (plus) symbol to create the new keytab object; let it <code>pocKeytab</code>. Click the <code>Upload</code> button to upload the <code>pocAllCrypto.keytab</code> file created before. To do a more deterministic test and a more easy problem determination in case of problems, leave the <code>Use Replay Cache</code> option unchecked. Conversely, for production use, is recommended to check the option for performance reason.</p> <p>Click on <code>Apply</code> to confirm the creation of the new object.</p> <p><a href="/wp-content/uploads/sites/88/2018/05/KerberosKeytab.png"><img src="/wp-content/uploads/sites/88/2018/05/KerberosKeytab.png" alt="IDG Console - Kerberos Keytab" class="alignnone size-full" height="599" width="1003"></a></p> <p>Let continue to configuration of the AAA action.</p> </li> <li><p><strong>Resource Identification Method</strong>: select <code>URL sent by Client</code> option:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/AAAResourceIdentification.png"><img src="/wp-content/uploads/sites/88/2018/05/AAAResourceIdentification.png" alt="IDG Console - AAA Resource Identification" class="alignnone size-full" height="576" width="1003"></a></p> </li> <li><p><strong>Authorization method</strong>: select <code>Allow any authenticated client</code>:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/AAAAuthorization.png"><img src="/wp-content/uploads/sites/88/2018/05/AAAAuthorization.png" alt="IDG Console - AAA Authorization" class="alignnone size-full" height="568" width="1003"></a></p> </li> <li><p><strong>Post-processing</strong>: leave all unchanged, and click <code>Commit</code>.</p> <p><a href="/wp-content/uploads/sites/88/2018/05/AAAPostProcessing.png"><img src="/wp-content/uploads/sites/88/2018/05/AAAPostProcessing.png" alt="IDG Console - AAA Post Processing" class="alignnone size-full" height="944" width="1003"></a></p> </li> </ol> <p>Apply all the configurations and ensure that the Multiprotocol gateway is in state <code>Up</code>.</p> <a name="using-an-http-client-to-test-the-configuration"><span class="header-link"></span></a><h3>Using an HTTP client to test the configuration</h3><p>In this section we’ll use a general purpose HTTP client to test the DataPower configuration, verifying that only requests having a valid SPNEGO token (carrying a valid Kerberos ticket) are served. As an example, we can use the open source version of SoapUI client from SmartBear (<a href="https://www.soapui.org)">https://www.soapui.org)</a>, because supports by default the creation of SPNEGO token.</p> <p>Since the client must be able to produce Kerberos/SPNEGO artifacts, it must run on a Windows Machine, logged in the Windows domain.</p> <p>As first test, we’ll use our client to verify that a “plain” request not carrying an SPNEGO token is rejected by the DataPower. Create a new SoapUI project, with a GET HTTP request, as show below, and try to send a GET request to the URL <a href="http://datapower.mydomain.local">http://datapower.mydomain.local</a>.</p> <p><a href="/wp-content/uploads/sites/88/2018/05/SoapUI.png"><img src="/wp-content/uploads/sites/88/2018/05/SoapUI.png" alt="SoapUI" class="alignnone size-full" height="627" width="1003"></a></p> <p>The request is rejected by the DataPower, as you can see in the right canvas of SoapUI, with the message <code>Rejected by policy</code>. More in detail, let examine the logs: the client sent a GET / request; since the target service is protected using Kerberos/SPNEGO authentication, the DataPower responds with HTTP 401 Unauthorized, and presenting to the client the SPNEGO authentication challenge: <code>WWW-Authenticate: Negotiate</code>. Notice that this a SPNEGO specific challenge, that must not be confused with the NTLM challenge, also used in a Windows Domain under certain other conditions. In this test, SoapUI has not been configured to respond to the challenge and the request/response transaction terminates without other exchanges.</p> <p>Let we configure SoapUI to respond to the <code>Negotiate</code> challenge. The configuration is quite long, but is well explained at the following link: <a href="https://www.soapui.org/soap-and-wsdl/spnego/kerberos-authentication.html">https://www.soapui.org/soap-and-wsdl/spnego/kerberos-authentication.html</a> As explained in the SoapUI documentation, we need to complete following configuration steps:</p> <ol> <li>modify a Windows Registry key in order to allows the SoapUI JVM to access the Ticket-Granting Ticket (TGT) session key</li> <li>create a keytab (<code>Administrator.keytab</code>) containing the user password to be used</li> <li>create a configuration file (<code>krb5.conf</code>) containing information about the Key Distribution Center (KDC) that will be used by SoapUI to retrieve the service ticket</li> <li>create a configuration file (<code>login.conf</code>) to be used by SoapUI JAAS Login Module</li> <li>modify the SoapUI JVM options to access the files created before</li> <li>request a TGT and save it to a cache file, to be accessed later by SoapUI, and used to retrieve the final service ticket</li> </ol> <p>Create a folder called <code>c:\kerberos</code> to store the files created in steps 2, 3, 4.</p> <p><strong>Step 1 - Modify the Windows Registry</strong> Refer to the SoapUI documentation, at the link specified above.</p> <p><strong>Step 2 - Crete a keytab containing the user password</strong> Open a DOS prompt, enter the <code>&lt;SoapUI_Install_Dir&gt;/jre/bin</code> directory and launch the following command:</p> <pre><code>ktab -a Administrator Passw0rd! -k C:\kerberos\Administrator.keytab
</code></pre><p><a href="/wp-content/uploads/sites/88/2018/05/CMDCreateKeyTab.png"><img src="/wp-content/uploads/sites/88/2018/05/CMDCreateKeyTab.png" alt="CMD - Create keytab" class="alignnone size-full" height="475" width="1003"></a></p> <p>Assure that the file <code>Administrator.keytab</code> has been created in the <code>C:\kerberos</code> folder.</p> <p><strong>Step 3 - Create the configuration file krb5.conf containing information of the KDC</strong> In the same <code>C:\kerberos</code> folder, create the <code>krb5.conf</code> file containing the following:</p> <pre><code>[libdefaults]
    default_realm = MYDOMAIN.LOCAL
    udp_preference_limit = 1
[realms]
    MYDOMAIN.LOCAL = {
        kdc = winserver.mydomain.local
        default_domain = MYDOMAIN.LOCAL
}
[domain_realms]
    .mydomain.local=MYDOMAIN.LOCAL
</code></pre><p><strong>Step 4 - Create the configuration file login.conf for the JVM JAAS Login Module</strong> In the same <code>C:\kerberos</code> folder, create the <code>login.conf</code> file containing the following:</p> <pre><code>com.sun.security.jgss.login {
  com.sun.security.auth.module.Krb5LoginModule
  required
  client=TRUE;
};
com.sun.security.jgss.initiate {
  com.sun.security.auth.module.Krb5LoginModule
  required
  debug=true
  useTicketCache=true
  useKeyTab=true
  keyTab=&quot;file:///C:/kerberos/Administrator.keytab&quot;
  principal=&quot;Administrator@MYDOMAIN.LOCAL&quot;
  doNotPrompt=true;
};
com.sun.security.jgss.accept {
  com.sun.security.auth.module.Krb5LoginModule required client=TRUE useTicketCache=true;
};
</code></pre><p><strong>Step 5 - Modify the SoapUI JVM options to use the new configuration files</strong> Refer to the SoapUI documentation to complete this steps.</p> <p>As a result, the file <code>&lt;SoapUI_Install_Dir&gt;/bin/SoapUI.xxx.vmoptions</code> must contain the following three lines:</p> <pre><code>...
-Djavax.security.auth.useSubjectCredsOnly=false
-Djava.security.auth.login.config=C:/kerberos/login.conf
-Djava.security.krb5.conf=C:/kerberos/krb5.conf
...
</code></pre><p><strong>Step 6 - Request a TGT ticked and save it to a cache file</strong> Using a DOS prompt, enter the <code>&lt;SoapUI_Install_Dir&gt;/jre/bin</code> directory start the following interactive command and, when requested, enter the Administrator password (or the password for the user that is logged on the Windows domain):</p> <pre><code>kinit
</code></pre><p><a href="/wp-content/uploads/sites/88/2018/05/CMDkinit.png"><img src="/wp-content/uploads/sites/88/2018/05/CMDkinit.png" alt="CMD - kinit" class="alignnone size-full" height="473" width="1003"></a></p> <p>Assure that the file <code>krb5cc_Administrator</code> is created in the Administrator’s home folder.</p> <p>IMPORTANT: The TGT stored in the cache file expires after a while. Using the command <code>klist</code> you can see the when the ticket has been issued and when it will expire:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/CMDklist.png"><img src="/wp-content/uploads/sites/88/2018/05/CMDklist.png" alt="CMD - klist" class="alignnone size-full" height="474" width="1003"></a></p> <p>If the TGT is expired, simply regenerate it running the command kinit again.</p> <p>Restart the SoapUI.</p> <p>Retry to send the GET HTTP request to the target <a href="http://datapower.mydomain.local">http://datapower.mydomain.local</a>: the request sill be server by DataPower.</p> <p><a href="/wp-content/uploads/sites/88/2018/05/SoapUI2.png"><img src="/wp-content/uploads/sites/88/2018/05/SoapUI2.png" alt="SoapUI2" class="alignnone size-full" height="627" width="1003"></a></p> <p>More in detail, let examine the http logs produced by SoapUI: the first request sent by the client is not carrying any security token, and the response from DataPower is a HTTP 401 Unauthorized, with the SPNEGO challenge <code>www-Authenticate: Negotiate</code>. This this, the SoapUI generates the SPNEGO token using the parameters we provided in the files created before, and try a second request attaching the <code>Authorization: Negotiate .....</code> header, i.e. attaching the just generated SPNEGO token. The DataPower is now able to acquire the SPNEGO token, decrypt it using one of supported decryption algorithm and the corresponding key that we put in his keytab file, extract the Kerberos ticket, validate it, and proceed proxying the request to the target backend. We can see the full history using the DataPower logs.</p> <p>The first request generates following logs:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/IDGConsoleFirstReqLog.png"><img src="/wp-content/uploads/sites/88/2018/05/IDGConsoleFirstReqLog.png" alt="IDG Console - First Request Logs" class="alignnone size-full" height="989" width="1003"></a></p> <p>Reading bottom-up (as usual), the AAA action activates but fails with the message <code>failed to extract ticket from Kerberos AP-REQ message</code>. Then <code>kerberos authentication failed with (kerberos, kerberos-apreq=*not-present*)</code>. In fact, in the first request there is no SPNEGO token in the request.</p> <p>The second request, conversely, produces following logs:</p> <p><a href="/wp-content/uploads/sites/88/2018/05/IDGConsoleSecondReqLog.png"><img src="/wp-content/uploads/sites/88/2018/05/IDGConsoleSecondReqLog.png" alt="IDG Console - Second Request Logs" class="alignnone size-full" height="774" width="1003"></a></p> <p>After AAA action activation, the log says <code>parse-apreq: successfully parsed Kerberos AP-REQ: client &#39;Administrator@MYDOMAIN.LOCAL...</code> and then kerberos authentication succeded.</p> <a name="troubleshooting-tips"><span class="header-link"></span></a><h3>Troubleshooting Tips</h3><p>If you have trouble, pls take a look to following links, explaining common causes:</p> <ul> <li><p>Kerberos Token version: <code>http://www-01.ibm.com/support/docview.wss?uid=swg21502341</code></p> </li> <li><p>FIPS Mode enabled on DataPower Gateway: <code>https://www.ibm.com/support/knowledgecenter/en/SS9H2Y_7.5.0/com.ibm.dp.doc/nist_cryptomodeoverview.html</code></p> </li> </ul>
